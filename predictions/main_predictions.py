####################################################################################################################################################################################
####################################################################################################################################################################################
####################################################################################################################################################################################
import warnings; warnings.simplefilter("ignore", category=Warning)
import os; os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'

####################################################################################################################################################################################
####################################################################################################################################################################################
import xarray as xr
import numpy as np

import json
import sys
import gc

####################################################################################################################################################################################
####################################################################################################################################################################################
from src.utils_predictions import *

####################################################################################################################################################################################
####################################################################################################################################################################################
print('READ CONFIGURATION')
config_file  = json.load(open('./config/config.json'))
model_name   = config_file['model_name'] 
lossf        = config_file['lossf']
target_var   = config_file['target_var']
threshold_pr = config_file['threshold_pr']
input_path   = config_file['input_path']
output_path  = config_file['output_path']
domain_path  = config_file['domain_path']
domain       = config_file['domain'] 
train_exp    = config_file['train_exp']
pred_period  = config_file['pred_period']
pred_type    = config_file['pred_type']
pred_model   = config_file['pred_model']
del config_file, json
gc.collect()

####################################################################################################################################################################################
####################################################################################################################################################################################
print('LOAD PREDICTORS')
predictor = load_data(domain_path, domain, train_exp, pred_period, pred_type, pred_model)
time      = predictor.coords['time'].values
del load_data
gc.collect()

####################################################################################################################################################################################
####################################################################################################################################################################################
print('REMOVE NANS')
#predictor  = remove_days_with_nans(predictor, {'lat':'lat', 'lon':'lon'})
del remove_days_with_nans
gc.collect()

####################################################################################################################################################################################
####################################################################################################################################################################################
print('STANDARDIZE THE PREDICTORS')
predictor = standardize(data_ref=predictor, data=predictor)
del standardize
gc.collect()

####################################################################################################################################################################################
####################################################################################################################################################################################
print('CONVERT TO NUMPY')
x_train_arr = xarray_to_numpy(predictor)
del xarray_to_numpy, predictor
gc.collect()

print(np.mean(x_train_arr))

####################################################################################################################################################################################
####################################################################################################################################################################################
print('PREDICT ON TEST DATASET')
x_teste_forecast = predict_model(x_train_arr, output_path, model_name, lossf, input_path, train_exp, domain, target_var, threshold_pr)
del predict_model, x_train_arr
gc.collect()

nt, nx = x_teste_forecast.shape
xforecast_reshape = x_teste_forecast.reshape(int(nt), int(np.sqrt(nx)), int(np.sqrt(nx)))
del x_teste_forecast
gc.collect()

####################################################################################################################################################################################
####################################################################################################################################################################################
print('READ TARGET COORDS')
out_lo, out_la, out_xx, out_yy = load_coords(domain)

####################################################################################################################################################################################
####################################################################################################################################################################################
print('SAVE MODEL OUTPUT')
save_results(model_name, domain, output_path, train_exp, target_var, pred_period, pred_type, pred_model, xforecast_reshape, time, out_lo, out_la, out_xx, out_yy)

sys.exit()
